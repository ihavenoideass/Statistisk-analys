---
title: "inlämning 3"
author: "Umut Arslan"
date: "2023-03-06"
output: pdf_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE, message=FALSE}

library(ISLR2)
library(mgcv)
library(dlookr)
library(GGally)
library(ggplot2)
library(Hmisc)
library(corrplot)
library(skimr)
library(recipes)
library(tidyr)
library(dplyr)
library(inspectdf)
library(randomForest)
library(caTools)
library(caret)
library(stringr)

```
## Datasett taget ifrån bibloteket ISLR2, Auto.

Auto innehåller 9 olika kolumner där mpg, displacement och acceleration är av datatypen Numerical, kontinuerliga siffror.

Cylinders, horsepower, weight, year och origin är av datatypen Integer, heltal.

Name är av datatypen Factor


Mpg är hur många "miles" per "gallon" bilen drar, cylinders är antalet cylindrar bilen har, displacment är slagvolym för bilen, horsepower är hästkraften för bilen, weight är vikten på bilen, acceleration är definierad som tiden att accelerera från 0 till ungefär 96km/h, year är årsmodellen på bilen, origin är vart bilen kommer ifrån (1. Amerika, 2. Europa, 3. Japan), name är bilens namn.



```{r, echo = FALSE}
#Läser in data Auto
data(Auto)


#show_plot(inspect_na(Auto))
#Kollar hur dataframe auto är "byggd"
#str(Auto)

```


Nedan kan vi se att cylinders och origin ser ut att vara kategoriska variabler. När vi gör våran gam-modell kommer vi att sätta dessa som "dummie" variabler.

```{r, echo = FALSE, message= FALSE}


## Detta behövs för ggpairs, annnrs blir corr-värdena så småa.
cor_func <- function(data, mapping, method, ...){
  x <- eval_data_col(data, mapping$x)
  y <- eval_data_col(data, mapping$y)
  
  corr <- cor(x, y, method=method, use='complete.obs')
  
  
  ggally_text(
    label = as.character(round(corr, 2)), 
    mapping = aes(),
    xP = 0.5, yP = 0.5,
    color = 'black',
    ...
  )
}



## Korrplott, scatterplott samt grafer som visar "normalfördelning".
ggpairs(Auto[c(-9)], diag=list(continuous=wrap("densityDiag", col="black", fill="#F13232", alpha=0.5, size=1)), upper = list(continuous = wrap(cor_func,
                                       method = 'spearman')), title = "Korrelationsplott mellan förklaringsvariabler samt fördelningskurvor för resp variabel") + theme_minimal()


```


## GAM av datasett Auto

När vi undersöker diverse modeller så kommer jag fram till att man skulle kunna excludera förklaringsvariabeln origin beroende på vilken gräns man har, jämför man modellen med alla variabler mot modell med alla minus origin så blir resultatet försummbart.

```{r, echo = FALSE}
# Gam model med valfri antal df, modellen estimerar vad den anser är "bäst".
gam1 <- gam(mpg ~ s(displacement) + s(weight) + s(year)+ s(horsepower) + s(acceleration) + as.factor(origin) + as.factor(cylinders), data = Auto)


gam32 <- gam(mpg ~ s(displacement) + s(weight) + s(year)+ s(horsepower) + s(acceleration) + as.factor(cylinders), data = Auto)

#Jag väljer DENNA!!!!!!! ####
gam2 <- gam(mpg ~ s(displacement) + (weight) + (year)+ (horsepower) + s(acceleration) + as.factor(origin) + as.factor(cylinders), data = Auto)

#Tog bort icke-linjära parametrarna, displacement och acceleration
gam3 <- gam(mpg ~  + s(weight) + s(year)+ s(horsepower)  + as.factor(origin) + as.factor(cylinders), data = Auto)

gam4 <- gam(mpg ~  + s(weight) + s(year)+ s(displacement)  + as.factor(origin) + as.factor(cylinders), data = Auto)

model <- gam(mpg ~ s(displacement) + s(weight) + s(year) + origin + cylinders, data = Auto)


#summary(gam2)
#jämför modellerna i anova
#anova(gam1, gam32, gam2, test = "F")
```
Nedan kan vi se att acceleration samt displacement har ett icke-linjärt samband medan resterande av förklaringsvariablerna ser ut att ha ett linjärt samband med mpg. Modellen visar även att antalet cylindrar påverkar mpg negativt, alltså desto fler cylindrar tenderar att minska konsumptionen av bränsle. Samma sak gäller för weight och horsepower. Year ger ökad mpg.


```{r, echo = FALSE}
#Plottar gam modell
par(mfrow =c(1, 5))
plot.gam(gam1, se = TRUE)
```


## Titanic datasett
Datasettet innehåller Passangerid, Survived, Pclass, Name, Sex, Age, SibSp, Parch, Ticket, Fare, Cabin och Embarked

* PassangerId är passangerarnummret
* Survivad (0 = No, 1 = Yes)
* Pclass - Vilken klass passageraren hade, där 1 är första klass, 2 är andra och tre är tredje klass.
* Name är personernas namn
* Sex är vilket kön personen hade
* Age är vilken ålder personen hade
* SibSp är antalet syskon/sambo personen hade på båten
* Parch är antalet föräldrar/barn personen hade på båten
* Ticket är vilket nummer personen hade på  biljetten
* Fare är avgiften personen betalade för biljetten
* Cabin är vart personen hade sin hytt
* Embarked är vilket hamn passageraren steg in på båten (C = Cherbourg; Q = Queenstown; S = Southampton)


Jag kommer att transformera Name och Cabin till title och Decck. title kommer att innehålla Mr, Miss, Mrs eller Master och Deck kommer innehålla bokstaven A till G beroende på vart dom hade sin hytt.

Name och Cabin kommer att tas bort från datasettet.

```{r, echo = FALSE}

# Läser in datat
titanic <- read.csv("titanic.csv")



 # Kollar andel överlevande mot icke-överlevande
#titanic %>% 
#  count(Survived) %>% 
#  mutate(prop = n/sum(n))





## Extraherar string från Name till title på det som innehåller endast Mr, Miss, Mrs eller Master, om ej så får title värder unknown.
titanic <- titanic %>% 
  mutate(title = str_extract(Name, regex("Mr|Miss|Mrs|Master")),
         title = if_else(is.na(title), 'Unknown', title))


#Extraherar string från Cabin till Deck på det som innehåller endast A-G, om ej så får Deck värder unknown.
titanic <- titanic %>% 
  mutate(Deck = str_extract(Cabin, "[A-G]"),
         Deck = if_else(is.na(Deck), 'Unknown', Deck))
#Tar bort Name och Cabin för jag har redan skapat nya variabler av dessa två.
titanic <- titanic[c(-4, -11)]


```
Vi börjar med att undersöka om det saknas datapunkter.
```{r, echo = FALSE}
# Kollar andel missningness
skim(titanic)%>%
  tibble::as_tibble()
#show_plot(inspect_na(titanic))




```
Figuren ovan visar oss att cirka 20% av variabeln "Age" saknas i datat.

Antingen tar vi bort dom raderna, det vill säga 177 rader, eller så kan vi "impute missing data". Vi testar att göra det sistnämda.
```{r, echo = FALSE}
#str(titanic)

# gör om alla som har klass character till factor för att kunna imputa med knn

titanic$Survived <- factor(titanic$Survived)
titanic$Pclass <- factor(titanic$Pclass)
titanic$Sex <- factor(titanic$Sex)
titanic$Ticket <- factor(titanic$Ticket)
titanic$Embarked    <- factor(titanic$Embarked)
titanic$title    <- factor(titanic$title)
titanic$Deck        <- factor(titanic$Deck)


impute_recipe <- recipe(Survived ~ ., data = titanic) %>%
  step_impute_knn(all_predictors(), neighbors = 10) 
  impute_prep <- prep(impute_recipe, training = titanic)
  
  
  titanic_imp <- bake(impute_prep, titanic)
  

```
Nedan ser vi att det inte saknas några missing values från datasettet längre, detta gjordes med hjälp av step_impute_knn, där jag valde de 10 närmaste grannarna, dvs k = 10.
```{r, echo = FALSE}

skim(titanic_imp)%>%
  tibble::as_tibble()
#show_plot(inspect_na(titanic_imp))


```
##Random Forest importance

Baserat på utskriften nedan ser vi att den förklaringsvariabel som förklarar responsvariabeln bäst är Sex. Sedan kommer Ticket, Age, Fear, PassangerID, title, Pclass, Deck, SibSp, Embarked och sist Parch.
```{r, echo = FALSE}

#str(titanic_imp)

##Gör om alla klasser förutom sex till deras ursprungsklass för att kunna göra en randomForest på datat.
titanic_imp$Pclass <- as.integer(titanic$Pclass)
titanic_imp$Ticket <- as.character(titanic$Ticket)
titanic_imp$Embarked    <- as.character(titanic$Embarked)
titanic_imp$title    <- as.character(titanic$title)
titanic_imp$Deck        <- as.character(titanic$Deck)



rf <- randomForest(Survived ~ ., data = titanic_imp, na.action = na.pass)
importance(rf)


```


